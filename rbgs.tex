\section{Refinement-based game semantics}

This section introduces the category $\mathcal{G}$ of games and strategies
we use to interpret the behavior of low-level interacting components.
$\mathcal{G}$ has no high-order structure,
which simplifies the definition of games considerably.
On the other hand,
our definition of strategy is generalized to accomodate specifications,
and the morphisms of $\mathcal{G}$ are equipped with a notion of refinement
suitable for our purposes.

\subsection{Games}

\subsubsection{Elementary games}

The elementary games which underlie
our category of games and strategies
can be decribed in the following way.

\begin{definition}
An \emph{elementary game} is a pair
$A = \langle M_A^\kw{Q}, M_A^\kw{A} \rangle$, where
$M_A^\kw{Q}$ is a set of \emph{questions}, and
$M_A^\kw{A}$ is a set of \emph{answers}.
\end{definition}

The game proceeds as follows:
$\kw{O}$ chooses a question, then
$\kw{P}$ chooses an answer.
Elementary games place no restrictions
on the valid plays,
but this can be specified relationally.

\begin{definition}
A \emph{refinement convention} between elementary games $A_1$ and $A_2$
is a tuple
$\mathbb{C} = \langle W_\mathbb{C}, \preceq_\mathbb{C}^\kw{Q}, \preceq_\mathbb{C}^\kw{A} \rangle$
consisting in a set $W_\mathbb{C}$ of \emph{worlds},
and two relations
${\preceq}_\mathbb{C}^\kw{Q} : \mathcal{R}_{W_\mathbb{C}}(M_{A_1}^\kw{Q},M_{A_2}^\kw{Q})$ and
${\preceq}_\mathbb{C}^\kw{A} : \mathcal{R}_{W_\mathbb{C}}(M_{A_1}^\kw{A},M_{A_2}^\kw{A})$.
We write $\mathbb{C} : \mathcal{R}(A_1, A_2)$.
\end{definition}

Refinement conventions specify a correspondance
between the questions and answers of their source and target games,
which can be extended to plays and strategies.
The use of worlds ensures that the question and answer
are related in a consistent way.
If the source and target are the same game,
this is can be used to specify a set of valid plays
and augment the game with a notion of refinement.

\begin{definition}
A \emph{game with refinement} $\langle A, \preceq_A \rangle$
is an elementary game
$A = \langle M_A^\kw{Q}, M_A^\kw{A} \rangle$
together with a refinement convention
$\mathbb{C}_A = \langle W_{\!A}, {\preceq}_A^\kw{Q}, {\preceq}_A^\kw{A} \rangle
  : \mathcal{R}(A, A)$
such that $\preceq_A^\kw{Q}$ and $\preceq_A^\kw{R}$
are transitive at all worlds.
\end{definition}

In the context of games with refinement,
the valid plays and strategies will be the ones
that are self-related.
Our focus will be the plays and strategies
for the composite game $A \rightarrow B$
described in \S\ref{sec:arrow}.
Before we formally define them,
we start by addressing
the possibility for $\kw{P}$ to silently diverge
and to refuse any question from $\kw{O}$.

\subsubsection{Divergence}

We model internal actions in the following way.
Whenever $\kw{P}$ is to play,
it may instead signal that an internal action took place
by playing the special move $\tau$,
in which case $\kw{P}$ will retain control.
There is no limit on the number of internal actions that
$\kw{P}$ may perform before playing a regular move;
we say that a strategy \emph{diverges}
when it plays $\tau$ indefinitely.

Internal actions usually correspond to the hidden interactions
within composite systems, and
divergence is an \emph{emergent} phenomenon:
systems that are well-behaved when taken in isolation
may nontheless exhibit divergence when they interact with one another.
As such,
divergence is one of the major sources of complexity
in compositional semantics.

In our setting,
the occurence of internal actions
is observable,
and our definition of simulation
makes no effort
to identify finite sequences of internal actions
which have different lengths.
Instead,
in \S\ref{sec:bigstep}
we introduce an operator $- \backslash \tau^*$
that can be used to normalize strategies
by eliminating altogether all such finite sequences.

\subsubsection{Refusals}

In our model,
$\kw{P}$ may \emph{refuse} a question:
immediately after $\kw{O}$ plays a question,
$\kw{P}$ can play the special move $\kw{\#}$,
after which the game terminates.
In the context of
\emph{horizontal composition} (\S\ref{sec:hcomp}),
this will allow another component to proceed.

Note that a nondeterministic specification
may allow both answering and refusing a given question,
and that refusal must be distinguished from
the absence of behavior
(which in our setting would refine any specification).

%From there, we describe increasingly complex games,
%up to the composite game $A \rightarrow B$.
%Well-bracketed, alternating strategies for this game
%will serve as the morphisms of $\mathcal{G}$.
%
%\subsubsection{Iteration}
%
%If we allow multiple iterations of the game,
%the plays will be paths from $\kw{O}$ in the following graph:
%\[
%  \begin{tikzpicture}[baseline=(O.base)]
%    \node (O) at (0,0) {\kw{O}};
%    \node (P) at (1,0) {\kw{P}};
%    \path [->] (O) edge[bend left] node[auto] {$m$} (P);
%    \path [->] (P) edge[bend left] node[auto] {$n$} (O);
%  \end{tikzpicture}
%  \qquad
%  \begin{array}{c@{\,}l}
%    m &\in M_A^\kw{Q} \\[1ex]
%    n &\in M_A^\kw{A}
%  \end{array}
%\]
%To formalize the relational aspects of iterated elementary games,
%we can adjust the graph above so that its vertices are taken
%from the set of worlds extended with a starting point $\star$,
%and its edges are labelled by \emph{pairs} of related moves:
%\[
%  \begin{tikzpicture}[baseline=(O.base)]
%    \node (O) at (0,0) {$\star$};
%    \node (P) at (2,0) {$w$};
%    \path [->] (O) edge[bend left] node[auto] {$m_1, m_2$} (P);
%    \path [->] (P) edge[bend left] node[auto] {$n_2, n_2$} (O);
%  \end{tikzpicture}
%  \qquad
%  \begin{array}{c}
%    (m_1, m_2) \in {\preceq}_A^\kw{Q} \\[.5ex]
%    w \in W_{\!A} + \star \\[.5ex]
%    (n_1, n_2) \in {\preceq}_A^\kw{A}
%  \end{array}
%\]
%Two sequences of moves $s_1, s_2$
%are related at a world $w$
%if the graph contains a path $s : \star \leadsto w$
%such that $s_1 = \pi_1^*(s)$ and $s_2 = \pi_2^*(s)$.
%A strategy $\sigma_1$ is simulated by a strategy $\sigma_2$ if
%any move $n_1$ of $\sigma_1$ at the position $s_1$
%matches a corresponding move $n_2$ of $\sigma_2$ at the position $s_2$,
%such that $n_1 \preceq_A^\kw{A} n_2$.

\subsubsection{Arrow games}
\label{sec:arrow}

The arrow game $A \rightarrow B$ consists of
nested iterations of the elementary games $A$ and $B$.
In instances of $A$, the roles of $\kw{P}$ and $\kw{O}$ are exchanged;
instances of $B$ proceed normally.
When a new instance is initiated,
the current game is suspended
until the new instance concludes.

Accounting for internal actions and refusals,
the valid plays of $A \rightarrow B$
are described by the following graph:
\[
  \begin{tikzpicture}[baseline=(O1.base)]
    \node (O1) at (0,0) {\kw{O}};
    \node (P1) at (1,0) {\kw{P}};
    \node (O2) at (2,0) {\kw{O}};
    \node (P2) at (3,0) {\kw{P}};
    \node (O3) at (4,0) {$\ldots$};
    \node (R) at (3,1.5) {\kw{P}};
    \node (H) at (4,1.5) {$\kw{O}$};
    \path [->] (R) edge node[auto] {$\#$} (H);
    \path [->] (-0.5,0) edge (O1);
    \path [->] (O1) edge[bend left] node[auto] {$m$} (P1);
    \path [->] (O1) edge[bend left] node[auto] {$m$} (R);
    \path [->] (P1) edge[bend left] node[auto] {$n$} (O1);
    \path [->] (P1) edge[bend left] node[auto] {$q$} (O2);
    \path [->] (P1) edge[loop below] node[auto] {$\tau$} (P1);
    \path [->] (O2) edge[bend left] node[auto] {$r$} (P1);
    \path [->] (O2) edge[bend left] node[auto] {$m$} (P2);
    \path [->] (O2) edge[bend left] node[auto] {$m$} (R);
    \path [->] (P2) edge[bend left] node[auto] {$n$} (O2);
    \path [->] (P2) edge[bend left] node[auto] {$q$} (O3);
    \path [->] (P2) edge[loop below] node[auto] {$\tau$} (P2);
    \path [->] (O3) edge[bend left] node[auto] {$r$} (P2);
  \end{tikzpicture}
  \quad
  \begin{array}{c@{\,}lc@{\,}l}
    m &\in M_B^\kw{Q} & q &\in M_A^\kw{Q} \\[1ex]
    n &\in M_B^\kw{A} & r &\in M_A^\kw{A}
  \end{array}
\]
The first move is always a question $m$ played by $\kw{O}$ in $B$.
The player $\kw{P}$ can conclude the current instance of $B$
with an answer $n$, or
initiate an instance of $A$
with a question $q$.
Then $\kw{O}$ can initiate a new instance of $B$
with another $m$, or
conclude any current instance of $A$
with an answer $r$.
This process goes on indefinitely.

%A corresponding relational frame can be defined
%on worlds of the form $\vec{w} \in (W_{\!A} + W_B)^*$.
%The starting state $\varepsilon$ corresponds to
%the leftmost $\kw{O}$ position above.
%The transitions are as follows.
%\[
%  \begin{array}{c@{\qquad}c}
%    \text{For $\lvert \vec{w} \rvert$ even:} &
%    \text{For $\lvert \vec{w} \rvert$ odd:} \\[1ex]
%    \AxiomC{$m_1 \ifr{w \Vdash {\preceq}_B^\kw{Q}} m_2$}
%    \UnaryInfC{$\vec{w} \stackrel{m_1, m_2}{\leadsto} w :: \vec{w}$}
%    \DisplayProof
%    &
%    \AxiomC{$q_1 \ifr{w \Vdash {\preceq}_A^\kw{Q}} q_2$}
%    \UnaryInfC{$\vec{w} \stackrel{q_1, q_2}{\leadsto} w :: \vec{w}$}
%    \DisplayProof
%    \\[3.3ex]
%    \AxiomC{$n_1 \ifr{w \Vdash {\preceq}_B^\kw{A}} n_2$}
%    \UnaryInfC{$w :: \vec{w} \stackrel{n_1, n_2}{\leadsto} \vec{w}$}
%    \DisplayProof
%    &
%    \AxiomC{$r_1 \ifr{w \Vdash {\preceq}_A^\kw{A}} r_2$}
%    \UnaryInfC{$w :: \vec{w} \stackrel{r_1, r_2}{\leadsto} \vec{w}$}
%    \DisplayProof
%  \end{array}
%\]
%As before,
%two sequences of moves are related if
%there is a corresponding path in the graph.

To formalize the plays and strategies of $A \rightarrow B$
in a way that accounts for refinement,
we decouple two aspects of this structure.
The following definition of plays
enforces the alternation between $\kw{O}$ and $\kw{P}$
and specifies how the special moves $\tau$ and $\#$ can be used.

\begin{definition}
Given two elementary games $A$ and $B$,
the moves of the arrow game $A \rightarrow B$
are the questions and answers of $A$ and $B$,
categorized as follows:
\begin{align*}
  M_{A \rightarrow B}^\kw{O} &= M_A^\kw{A} + M_B^\kw{Q} &
  M_{A \rightarrow B}^\kw{Q} &= M_A^\kw{Q} + M_B^\kw{Q} \\
  M_{A \rightarrow B}^\kw{P} &= M_A^\kw{Q} + M_B^\kw{A} &
  M_{A \rightarrow B}^\kw{A} &= M_A^\kw{A} + M_B^\kw{A}
\end{align*}
The \emph{plays} are taken in
the prefix closure $P_{A \rightarrow B}$ of the set:
\[
    (M_{A \rightarrow B}^\kw{O} \, \tau^*
     M_{A \rightarrow B}^\kw{P})^* \,
    (\varepsilon + M_{A \rightarrow B}^\kw{O} \#) \,.
\]
By analogy with the more usual notion of alternating plays,
we call \emph{even}
the empty play and the plays ending in
a move from $M_{A \rightarrow B}^\kw{P} \cup \{\#\}$, and
we call \emph{odd} the plays ending in
a move from $M_{A \rightarrow B}^\kw{O} \cup \{\tau\}$.
We write $P_{A \rightarrow B}^\kw{even}$ and $P_{A \rightarrow B}^\kw{odd}$
for the corresponding subsets of $P_{A \rightarrow B}$.
\end{definition}

The ``stack discipline'' associating questions
with their eventual answer is captured by
the way we extend refinement conventions to
the plays of $A \rightarrow B$.

\begin{definition}
Given
$\mathbb{C}_A : \mathcal{R}(A_1, A_2)$ and
$\mathbb{C}_B : \mathcal{R}(B_1, B_2)$,
we define the Kripke frame
$\mathcal{F}_{A \rightarrow B} =
 \langle W_{A \rightarrow B}, \leadsto \rangle$
labelled by pairs of moves,
where $W_{A \rightarrow B} = (W_A + W_B)^*$
and $\leadsto$ is the transition system
defined by the rules:
\[
    \AxiomC{$m_1 \ifr{w \Vdash {\preceq}^\kw{Q}} m_2$}
    \UnaryInfC{$\vec{w} \stackrel{m_1, m_2}{\leadsto} w :: \vec{w}$}
    \DisplayProof
    \quad
    \begin{array}{c}
      \vec{w} \stackrel{\#,\#}{\leadsto} \vec{w} \\[0.7ex]
      \vec{w} \stackrel{\tau, \tau}{\leadsto} \vec{w}
    \end{array}
    \quad
    \AxiomC{$m_1 \ifr{w \Vdash {\preceq}^\kw{A}} m_2$}
    \UnaryInfC{$w :: \vec{w} \stackrel{m_1, m_2}{\leadsto} \vec{w}$}
    \DisplayProof
\]
Then two plays are related at $\vec{w}$
when there is a path from $\varepsilon$ to $\vec{w}$
in $\leadsto$ whose labels project onto the plays:
\[
    \AxiomC{$s : \varepsilon \leadsto^* \vec{w}$}
    \UnaryInfC{$\pi_1^*(s)
       \ifr{\vec{w} \Vdash {\preceq}_{A \rightarrow B}}
       \pi_2^*(s)$}
    \DisplayProof
\]
If
$\langle A, \mathbb{C}_A \rangle$ and
$\langle B, \mathbb{C}_B \rangle$
are two games with refinement, then
a \emph{valid play} of $A \rightarrow B$
is a sequence $s \in P_{A \rightarrow B}$
such that $(s, s) \in [\vec{w} \Vdash {\preceq}_{A \rightarrow B}]$
for some $\vec{w}$.
\end{definition}

\subsection{Strategies}

A strategy for $A \rightarrow B$
is essentially a tree
which gathers the possible interactions of
the system being modeled.
We give a traditional representation
as a prefix-closed set of plays,
but will work with strategies defined as transition systems.

\subsubsection{Traces}

In the existing literature,
strategies are usually formalized as prefix-closed sets of plays.
This establishes a connection with trace semantics of process calculi.
In our case,
a strategy given in this form is a set:
\[ \sigma \subseteq P_{A \rightarrow B} \,, \]
which satisfies
for all $st \in P_{A \rightarrow B}$
and $m \in M_{A \rightarrow B}^\kw{O}$:
\begin{itemize}
  \item $st \in \sigma \Rightarrow s \in \sigma$;
  \item $s \in \sigma \wedge sm \in P_{A \rightarrow B}
    \Rightarrow sm \in \sigma$.
\end{itemize}
The first condition ensures that $\sigma$ is prefix-closed,
whereas the second condition ensures that
all possible behaviors of $\kw{O}$ are included
at all reachable positions.

\subsubsection{Transition systems}

Instead of manipulating sets of traces directly,
we will define strategies using a specialized form of transition system.

\begin{definition}
An \emph{strategy} $\sigma$ for the arrow game $A \rightarrow B$
is a tuple
$\langle K, S,
{\xrightarrow{\kw{O}}},
{\xrightarrow{\tau}},
{\xrightarrow{\kw{P}}},
 \#, k_0 \rangle$
where:
\begin{itemize}
  \item $K$ is a set of \emph{continuation states};
  \item $S$ is a set of \emph{running states};
  \item ${\stackrel{\kw{O}}{\rightarrow}} :
         K \rightarrow M_{A \rightarrow B}^\kw{O} \rightarrow \mathcal{P}(S)$
    is a \emph{resumption relation};
  \item ${\stackrel{\tau}{\rightarrow}} : S \rightarrow \mathcal{P}(S)$
    is an \emph{internal transition relation};
  \item ${\stackrel{\kw{P}}{\rightarrow}} :
         S \rightarrow \mathcal{P}(M_{A \rightarrow B}^\kw{P} \times K)$
    is a \emph{suspension relation};
  \item ${\#} : K \rightarrow \mathcal{P}(M_B^\kw{O})$
    is a \emph{refusal relation};
  \item $k_0$
    is the strategy's \emph{initial continuation}.
\end{itemize}
We will write:
\begin{itemize}
  \item $k \xrightarrow{m} s$ when ${\xrightarrow{\kw{O}}}(k, m) \ni s$, and
  \item $s \xrightarrow{m} k$ when ${\xrightarrow{\kw{P}}}(s) \ni (m, k)$.
\end{itemize}
We write $\sigma : A \rightarrow B$ when $\sigma$ is a strategy
for $A \rightarrow B$.
\end{definition}

Continuations correspond to
the points in the execution where $\kw{O}$ is expected to move,
whereas states correspond to
the points where $\kw{P}$ is expected to move.
The set of traces associated with a state is
defined by mutual recursion as:
\[
  \begin{array}{l@{\:}c@{\:\{}l@{\:\mid\:}l}
    \kw{traces}_\sigma(k) & = & \varepsilon, m &
      m \in M_{A \rightarrow B}^\kw{O} \} \\
    & \cup & m t &
      k \xrightarrow{m} s \wedge t \in \kw{traces}_\sigma(s) \} \\
    & \cup & m \# &
      k \: \# \: m \} \\
    \kw{traces}_\sigma(s) & = & \tau, \tau t &
      s \xrightarrow{\tau} s' \wedge t \in \kw{traces}_\sigma(s') \} \\
    & \cup & m t &
      s \xrightarrow{m} k \wedge t \in \kw{traces}_\sigma(k) \}
  \end{array}
\]
Then the behavior of strategies can be made explicit
by specifying the corresponding sets of plays as:
\[
  \kw{traces}(\sigma) = \kw{traces}_\sigma(k_0) \,.
\]

[Show that $\subseteq P_{A \rightarrow B}$,
and that it satisfies the requirements outlined
in the previous section.]

[Advantages: alternation structure baked in,
can be handled by the proof assistant's type system.
Facilitates embedding of operational semantics,
and intuitive operational reasoning.]

[Inconvenient: junk and non unique,
but we don't care because we're going to
define simulations and quotient anyway.]

\subsection{Simulations}

\begin{definition}
Given
$\mathbb{C}_A : \mathcal{R}(A_1, A_2)$,
$\mathbb{C}_B : \mathcal{R}(B_1, B_2)$
two refinement conventions, and
$\sigma_1 : A_1 \rightarrow B_1$,
$\sigma_2 : A_2 \rightarrow B_2$
two strategies,
a \emph{simulation relation} between $\sigma_1$ and $\sigma_2$
is a pair of relations $R = \langle R_S, R_K \rangle$ with
$R_K : \mathcal{R}_{W_{\!A \rightarrow B}}(K_1, K_2)$ and
$R_S : \mathcal{R}_{W_{\!A \rightarrow B}}(S_1, S_2)$
such that:
\begin{gather*}
  \xrightarrow{\kw{O}}_1
  \ifr{\Vdash R_K \rightarrow \Box \rightarrow \mathcal{P}^+(R_S)}
  \xrightarrow{\kw{O}}_2
  \\
  \xrightarrow{\tau}_1
  \ifr{\Vdash R_S \rightarrow \mathcal{P}^+(R_S)}
  \xrightarrow{\tau}_2
  \\
  \xrightarrow{\kw{P}}_1
  \ifr{\Vdash R_S \rightarrow \mathcal{P}^+(\Diamond \times R_K)}
  \xrightarrow{\kw{P}}_2
  \\
  \#_1
  \ifr{\Vdash R_K \rightarrow \Box \rightarrow {\Rightarrow}}
  \#_2
  \\
  k_{0,1} \ifr{\varepsilon \Vdash R_K} k_{0,2}
\end{gather*}
We will write
$\sigma_1 \le_{\mathbb{C}_A \rightarrow \mathbb{C}_B}^R \sigma_2$
when $R$ is a simulation relation in this sense, and write
$\sigma_1 \le_{\mathbb{C}_A \rightarrow \mathbb{C}_B} \sigma_2$
when there exists any such simulation relation.
\end{definition}

The modal relators $\Box, \Diamond$ are defined in \S\ref{sec:klrlabels},
and are used in the definition above
with respect to the frame $\mathcal{F}_{A \rightarrow B}$
defined in \S\ref{sec:arrow}.
Hence, the simulation operates in the context of
a stack of elementary worlds
specifying how the answers to pending questions
should be related.
In each one of the component games $A and B$,
answers will be related at the same world as the corresponding questions:
$\kw{P}$ can rely on $\kw{O}$ making this true for $A$;
it must guarantee that this is true for $B$.

\subsection{Horizontal composition}

Proceeds in 3 stages.

\subsubsection{Multi-component games and strategies}

The simplest way to aggregate a family of strategies $(\sigma_i)_{i\in I}$
is to annotate all of the moves exchanged by the system with its environment
by a component identifier $i$.

\begin{definition}
For an elementary game $A$ and a set $I$,
we define the \emph{multi-channel game}
$A^I = \langle I \times M_G^\kw{Q}, I \times M_G^\kw{A} \rangle$.
For a refinement convention
$\mathbb{C} : \mathcal{R}(A_1, A_2)$,
we define
$\mathbb{C}^I : \mathcal{R}(A_1^I, A_2^I)$
as
$\mathbb{C}^I = \langle I \rightarrow W_\mathbb{C}, \,
                        ({=} \rightarrow {\preceq}_\mathbb{C}^\kw{Q}), \,
                        ({=} \rightarrow {\preceq}_\mathbb{C}^\kw{A}) \rangle$.
\end{definition}

Then in the composite strategy can simply direct each move
to the corresponding component,
and let the components operate independently.

\begin{definition}
For a family of strategies
$\vec{\sigma} = (\sigma_i)_{i \in I}$
with
$\sigma_i = \langle K_i, S_i, \xrightarrow{\kw{O}}_i,
  \xrightarrow{\tau}_i, \xrightarrow{\kw{P}}_i, \#_i, k_{0i} \rangle :
  A \rightarrow B$,
the multi-component strategy
$\mathcal{M}(\sigma_i)_{i \in I} : A^I \rightarrow B^I$
is defined over the sets of states:
\[
  K := \prod_{i \in I} K_i \qquad
  S := \sum_{i \in I}
    \Big( S_i \times \prod_{i \ne j} K_j \Big)
\]
by the following rules:
\[
  \begin{array}{c@{\qquad}c}
    \AxiomC{$k_i \xrightarrow{m}_i s$}
    \UnaryInfC{$\vec{k} \xrightarrow{(i, m)} (i, s, \vec{k} \backslash i)$}
    \DisplayProof
    &
    \AxiomC{$s \xrightarrow{m}_i k_i$}
    \UnaryInfC{$(i, s, \vec{k} \backslash i) \xrightarrow{(i, m)} \vec{k}$}
    \DisplayProof
    \\[1.5em]
    \AxiomC{$s \xrightarrow{\tau}_i s'$}
    \UnaryInfC{$(i, s, \vec{k}) \xrightarrow{\tau} (i, s', \vec{k})$}
    \DisplayProof
    &
    \AxiomC{$k \: \#_i \: m$}
    \UnaryInfC{$\vec{k} \: \# \: (i, m)$}
    \DisplayProof
  \end{array}
\]
and uses the initial continuation $(k_{0i})_{i \in I}$.
\end{definition}

In other words,
at most one component is active at any time,
and the others remain in continuation states.
A resumption activates the component whose index
is read from the move,
and the index is incoroporated back into
any move played by the component.

\subsubsection{Flat composition}

Once we have such an aggregate,
we can ``flatten'' the communication between
the system and the environment
back to the unannotated game $A \rightarrow B$.

\begin{definition}
The \emph{flattening} of $\sigma : A^I \rightarrow B^I$
is the strategy $\sigma^\rhd : A \rightarrow B$
defined over the sets of states
$K := K_\sigma \times I^*$ and
$S := S_\sigma \times I^*$ by the following rules:
\[
  \begin{array}{c@{\quad}c}
    \AxiomC{$k \xrightarrow{(i, m)}_\sigma s$}
    \AxiomC{$\forall \, j \ne i \,.\, k \: \#_{\!\sigma} \: (j, m)$}
    \BinaryInfC{$(k, \iota) \xrightarrow{m} (s, \iota)$}
    \DisplayProof
    &
    \AxiomC{$s \xrightarrow{(i, n)}_\sigma k$}
    \UnaryInfC{$(s, \iota) \xrightarrow{n} (k, \iota)$}
    \DisplayProof
    \\[1.5em]
    \AxiomC{$s \xrightarrow{(i, q)}_\sigma k$}
    \UnaryInfC{$(s, \iota) \xrightarrow{q} (k, i :: \iota)$}
    \DisplayProof
    &
    \AxiomC{$k \xrightarrow{(i, r)}_\sigma s$}
    \UnaryInfC{$(k, i :: \iota) \xrightarrow{r} (s, \iota)$}
    \DisplayProof
    \\[1.5em]
    \AxiomC{$s \xrightarrow{\tau}_\sigma s'$}
    \UnaryInfC{$(s, \iota) \xrightarrow{\tau} (s', \iota)$}
    \DisplayProof
    &
    \AxiomC{$\forall \,i\,.\, k \: \#_{\!\sigma} \: (i, m)$}
    \UnaryInfC{$(k, \iota) \:\#\: m$}
    \DisplayProof
  \end{array}
\]
\end{definition}

We direct an incoming question in $B$
to a component $i$ when all other components reject it.
If the component then asks a question in the game $A$,
we save its identifier on the stack $\iota$,
so that the corresponding answer can be directed back to $i$.

Putting together multi-component strategies and flattening,
the \emph{flat composition} operator
$\mathcal{F} : [A \rightarrow B] \rightarrow [A \rightarrow B]$
is:
\[
    \mathcal{F}(\vec{\sigma}) := \mathcal{M}(\vec{\sigma})^\rhd
\]
This allows us to bundle multiple components of the same type,
however note that so far they do not interact with each other
(only to decide who's going to handle what question).

\subsubsection{Resolution operator}

To allow interaction within a composite system,
we define the following resolution operator,
which feeds back a strategy's own questions to itself
whenever possible.

\begin{definition}
The \emph{resolution} of $\sigma : A \rightarrow A$,
written $\mathcal{R}(\sigma)$,
is defined over the sets of states
$K := K_\sigma \times \{\kw{O}, \kw{P}\}^*$ and
$S := S_\sigma \times \{\kw{O}, \kw{P}\}^*$
by the following rules:
\[
  \begin{array}{cc}
    {\small m \in M_A^\kw{Q}, \:\: n \in M_A^\kw{A}}
    &
    {\small q \in M_A^\kw{Q}, \:\: r \in M_A^\kw{A}}
    \\[1em]
    \AxiomC{$k \xrightarrow{m}_\sigma s$}
    \UnaryInfC{$(k, \iota) \xrightarrow{m} (s, \kw{O} :: \iota)$}
    \DisplayProof
    &
    \AxiomC{$s \xrightarrow{n}_\sigma k$}
    \UnaryInfC{$(s, \kw{O} :: \iota) \xrightarrow{n} (k, \iota)$}
    \DisplayProof
    \\[1.5em]
    \AxiomC{$s \xrightarrow{q}_\sigma k$}
    \AxiomC{$k \:\#_{\!\sigma}\: q$}
    \BinaryInfC{$(s, \iota) \xrightarrow{q} (k, \iota)$}
    \DisplayProof
    &
    \AxiomC{$k \xrightarrow{r}_\sigma s$}
    \UnaryInfC{$(k, \iota) \xrightarrow{r} (s, \iota)$}
    \DisplayProof
    \\[1.5em]
    \AxiomC{$s \xrightarrow{q}_\sigma k$}
    \AxiomC{$k \xrightarrow{q}_\sigma s'$}
    \BinaryInfC{$(s, \iota) \xrightarrow{\tau} (s', \kw{P} :: \iota)$}
    \DisplayProof
    &
    \AxiomC{$s \xrightarrow{r}_\sigma k$}
    \AxiomC{$k \xrightarrow{r}_\sigma s'$}
    \BinaryInfC{$(s, \kw{P} :: \iota) \xrightarrow{\tau} (s', \iota)$}
    \DisplayProof
    \\[1.5em]
    \AxiomC{$s \xrightarrow{\tau}_\sigma s'$}
    \UnaryInfC{$(s, \iota) \xrightarrow{\tau} (s', \iota)$}
    \DisplayProof
    &
    \AxiomC{$k \:\#_{\!\sigma}\: m$}
    \UnaryInfC{$(k, \iota) \:\#\: m$}
    \DisplayProof
  \end{array}
\]
The initial continuation is $(k_{\sigma}, \varepsilon)$.
\end{definition}

\subsubsection{Observation operator}

.\\

{ \color{gray}
Note that for both states and continuations,
nondeterminism is interpreted as \emph{output} nondeterminism,
as prescribed by the use of the relator $\mathcal{P}^+$.
This means that alternating transition system
implicitely accept all possible inputs from the environment,
although some of them may cause the system to immediately go wrong.
Likewise,
the special resumption $\kw{refuse}$
is taken as a positive, output behavior from the system,
rather than a restriction on the environment ---
this will be important to establish the monotonicity
of the composition operator defined in Sec.~\ref{?}.
This approach corresponds to the saturation requirement on strategies
often found in traditional game semantics,
or notions of receptiveness used in CompCert
and in concurrency theory.

Furthermore, we need to distinguish between mere nondeterminism
and \emph{branching}.
This is explored in the following section.

\subsection{Branching and determinism}

Whereas nondeterminism allows a strategy to posess
multiple observable behaviors,
branching occurs when multiple state transitions
are associated with the same immediate observable behavior.
This can create spurious distinctions,
whereby systems that yield the same sets of traces
cannot be identified by simulation,
and as such we consider it undesirable.
The following definition
formalizes the conditions a transition system must satisfy
to be considered free from branching.

\begin{definition}[Nonbranching transition system]
For given sets of moves and states,
a continuation $k : M \rightarrow \mathcal{P}(\kw{resumption}(S))$
is \emph{nonbranching} if the following property holds:
\[ \forall m \,.\, | k(m) | \le 1 \]
A transition system $\alpha : \kw{ats}(M, S)$ is nonbranching
if the following property holds:
\[ \forall s, m, k_1, k_2 \,.\,
     \alpha(s) \supseteq \{ m \cdot k_1, m \cdot k_2 \} \Rightarrow
     k_1 = k_2 \,, \]
and if for all $s, m, k$ such that $\alpha(s) \ni \underline{m} \cdot k$,
the continuation $k$ is nonbranching.
\end{definition}

Determinism is a stronger property,
and ensures that the system has at most one possible behavior
at any point.
We expect the semantics of concrete systems ---
as opposed to specifications ---
to be deterministic in the following sense.

\begin{definition}[Deterministic transition system]
For given sets of moves and states,
a transition system $\alpha : \kw{ats}(M, S)$
is deterministic if for all $s$, $|\alpha(s)| \le 1$,
and if for all $s, m, k$ such that $\alpha(s) \ni \underline{m} \cdot k$,
the continuation $k$ is nonbranching.
\end{definition}

Note that both nonbranching and determinism
only relate to the behavior of the system.
In both cases,
the environment remains free to play any move.
Abramsky notes in \cite{cspgs}
that [it's one of the good things about game semantics].

\subsection{Internal actions and divergence}

The emergence of silent divergence
is one of the major difficulties
associated with modeling interacting systems.
Indeed,
two systems which, taken in isolation,
only exhibit reactive behavior,
can nonetheless become silently divergent when composed together,
if it is possible to interact with each other continuously
without intervening communication with the outside.

An operational description of this phenomenon
models this internal interaction explicitly
in the form of silent actions $\tau$.
When comparing the behavior of two systems,
finite sequences of $\tau$'s will be considered equivalent.
However,
silent divergence in the form of an infinite sequence of $\tau$'s
can only correspond to another infinite sequence.
This is usually addressed by the introduction of
sophisticated notions of simulation,
such as the \emph{measure simulations} used for instance in CompCert.

On the other hand,
in most work on denotational semantics,
including traditional game semantics such as \cite{pcfgs},
[complicated fixpoints] 

Our model includes a notion of internal action $\tau$,
which makes it possible to handle silent divergence explicitely
rather than through sophisticated domain-theoretic constructions.
However,
note that the notion of simulation we have defined
does not allow any variation
in the number of internal transitions
between the two transition systems being related.
Nevertheless,
composition operators remain monotonic
under this definition of simulation,
because [...]
Normalize using the following operator.

\begin{definition}[Observation operator]
For a transition system $\alpha : \kw{ats}(M, S)$,
we define the \emph{observations} transition system
$\mathcal{O}(\alpha)$ as follows.
A behavior $r : \kw{behavior}(M, S)$ is said to be
\emph{observable} if $r \ne \tau \cdot s$ for all $s \in S$.
A state $s' \in S$ is said to be \emph{reachable} from $s \in S$
if there is a sequence $s_0, s_1, \ldots s_n$ such that
$s_0 = s$, $s_n = s'$,
and for all $0 \le i < n$
there is a transition $\alpha(s_i) \ni \tau \cdot s_{i+1}$.
A state $s$ is said to be \emph{silently divergent}
if there is an infinite sequence $s_0, s_1, \ldots$
such that $s_0 = s$ and for all $i$,
there is a transition $\alpha(s_i) \ni \tau \cdot s_{i+1}$.
Then the observations transition system is defined as:
\begin{align*}
    \mathcal{O}(\alpha)(s) = &\{ r \:|\: r \mbox{ is observable } \wedge
         \exists s' \,.\, s \rightarrow^* s' \wedge
		\alpha(s') \ni r \} \\
      \cup &\{ \Delta \:|\: s \mbox{ is silently divergent} \}
\end{align*}
\end{definition}

Properties:
preserve nonbranching (if that's defined in the right way), determinism.
Monotonic.

}
