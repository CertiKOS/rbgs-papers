\usepackage{amsmath}
\usepackage{tikz}
\usepackage{xspace}
\usepackage{cleveref}
\usepackage{subcaption}
\captionsetup{compatibility=false}
\usepackage{paralist}
\usepackage{proof}
\usepackage{multirow}

\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{microtype}

\usepackage{stmaryrd}

\newcommand{\code}[1]{\texttt{\small #1}}
\newcommand{\scode}[1]{\texttt{\footnotesize #1}}
\newcommand{\sumbool}[2]{\{#1\} + \{#2\}}

%% \crefformat{section}{\S#2#1#3} % see manual of cleveref, section 8.2.1
%% \crefformat{subsection}{\S#2#1#3}
%% \crefformat{subsubsection}{\S#2#1#3}

\def\bs{\mathit{bs}}
\def\dt{\mathit{dt}}
\def\at{\mathit{at}}
\def\id{\mathit{id}}
\def\fid{\mathit{fid}}
\def\cons{\mathit{::}}
\def\ge{\mathit{ge}}

\def\defeq{\;\code{:=}\;}

\def\stage{\ensuremath{\code{stage}}\xspace}
\def\aframe{\ensuremath{\code{frame}}\xspace}
\def\astack{\ensuremath{\code{stage}}\xspace}

\def\tdomain{\mathbb{D}}
\newcommand{\ccal}[4]{#2 \vdash_{#1} #3: #4}
\newcommand{\bbsim}[2]{#2 \preccurlyeq^* #1}
\newcommand{\rcomp}[2]{#1 \circ #2}
\newcommand{\pcomp}[2]{#1 \oplus #2}



\def\mem{\code{mem}}
\newcommand\maxstack{\ensuremath{\code{MAX\_STACK}}\xspace}

\newcommand{\pushnewstage}{\ensuremath{\code{push\_stage}}\xspace}
\newcommand{\record}{\ensuremath{\code{record}}\xspace}
\newcommand{\popstage}{\ensuremath{\code{pop\_stage}}\xspace}

\newcommand{\nameset}[1]{\mathbb{#1}}
\newcommand{\freshness}[2]{#1 \# #2}

\def\none{\ensuremath{\emptyset}\xspace}
\def\nextblock{\texttt{\small nextblock}\xspace}

\newcommand{\compile}[1]{\mathcal{#1}}
\def\compcert{\mathcal{C}_{\texttt{compcert}}}

\newcommand{\genv}[1]{\mathcal{G}(#1)}
\newcommand{\sem}[1]{[\![#1]\!]}
\newcommand{\seml}[2]{[\![#1]\!]_{#2}}
\newcommand{\semn}[1]{[\![#1]\!]^{\mathcal{N}}}
\newcommand{\refine}[2]{#1 \sqsubseteq #2}

\newcommand{\lang}[1]{\mathcal{#1}}
\newcommand{\bsim}[2]{\sem{#2} \preceq \sem{#1}}
\newcommand{\fsim}[2]{\sem{#2} \succeq \sem{#1}}
\newcommand{\bsimn}[2]{\semn{#2} \preceq \semn{#1}}

\newcommand{\secref}[1]{Sec.~\ref{#1}\xspace}
\newcommand{\figref}[1]{Fig.~\ref{#1}\xspace}
\newcommand{\tabref}[1]{Table.~\ref{#1}\xspace}
\newcommand{\thmref}[1]{Theorem.~\ref{#1}\xspace}
\newcommand{\apdxref}[1]{Appendix.~\ref{#1}\xspace}

\def\ie{i.e.\xspace}
\def\eg{e.g.\xspace}

\newcommand{\inject}[3]{\ensuremath{ #2 \hookrightarrow_{#1} #3}}
\newcommand{\valinject}[3]{\ensuremath{ #2 \hookrightarrow_{#1}^v #3}}
\newcommand{\meminject}[3]{\ensuremath{ #2 \hookrightarrow_{#1}^m #3}}
\newcommand{\memvalinject}[3]{\ensuremath{ #2 \hookrightarrow_{#1}^i #3}}
\newcommand{\frameinject}[3]{\ensuremath{ #2 \hookrightarrow_{#1} #3}}
\newcommand{\tframeinject}[3]{\ensuremath{ #2 \hookrightarrow_{#1} #3}}
\newcommand{\stackinject}[4]{\ensuremath{ #3 \hookrightarrow_{#1}^{#2} #4}}


\def\append{\mathit{++}}
\def\imply{\Longrightarrow}

\newcommand{\kwd}[1]{\ensuremath{\text{\ttfamily #1}}\xspace}

\def\kempty{\kwd{empty}}
\def\kid{\kwd{id}}
\def\ktoken{\kwd{token}}
\def\kfield{\kwd{field}}
\def\kclass{\kwd{class}}
\def\kconstr{\kwd{constr}}

\def\kfld{\kwd{fld}}
\def\kcls{\kwd{cls}}

\newcommand{\larg}[1]{\%{#1}}
\def\app{\;}
\def\sep{\;|\;}
\def\mempty{\langle \kempty \rangle}

\def\DL{\mathit{DL}\xspace}
\def\TID{\mathit{tid}\xspace}
\def\FID{\mathit{fid}\xspace}
\def\KID{\mathit{kid}\xspace}
\def\GID{\mathit{GID}\xspace}
\def\AID{\mathit{aid}\xspace}
\def\BID{\mathit{BID}\xspace}
\def\CID{\mathit{cid}\xspace}


\newcommand{\var}[1]{\texttt{#1}}
\newcommand{\is}{\ensuremath{\leftarrow} }

\newcommand{\fld}[1]{\kfld\app \larg{#1}\xspace}
\newcommand{\cls}[1]{\kcls\app \larg{#1}\xspace}
\newcommand{\pseq}[2]{#1\app \kwd{;}\app #2\xspace}
\newcommand{\pconj}[2]{#1\app \kwd{\&}\app #2\xspace}
\newcommand{\pfeq}[2]{#1 = #2\xspace}
\newcommand{\pfneq}[2]{#1 \not= #2\xspace}
\def\pempty{\epsilon}

\def\ispec{\ensuremath{\mathcal{S}}\xspace}
\def\galg{\ensuremath{\mathcal{G}}\xspace}
\def\fspec{\ensuremath{\mathbb{S}}\xspace}
\def\enc{\ensuremath{\mathbb{E}}\xspace}
\def\dec{\ensuremath{\mathbb{D}}\xspace}
\def\ast{\ensuremath{\mathbb{A}}\xspace}

\newcommand{\CSLED}{CSLED\xspace}
\newcommand{\encode}[2]{\mathbb{E}_{#1}(#2)}
\newcommand{\decode}[2]{\mathbb{D}_{#1}(#2)}
\newcommand{\some}[1]{\lfloor #1 \rfloor}
\newcommand{\specrel}[3]{\fspec_{#1}(#2,#3)}


\newcommand{\modrm}{\textbf{ModRM}}
\newcommand{\opcode}{\textbf{Opcode}}
\newcommand{\regop}{\textbf{Reg\_Op}}

\newcommand{\todo}[1]{\textbf{#1}}
\newcommand{\component}[1]{\mathcal{#1}}
\newcommand{\pcomponent}[1]{\(\mathcal{#1}\)}
\newcommand{\pkwd}[1]{\textit{#1}}


\newcommand{\interp}[1]{\llbracket #1 \rrbracket}
\newcommand{\interpR}[1]{\ensuremath{\mathbb{R}\interp{#1}}}
\newcommand{\interpPat}[1]{\ensuremath{\mathbb{R}_p\interp{#1}}}
\newcommand{\interpConstr}[1]{\ensuremath{\mathbb{R}_b\interp{#1}}}
\newcommand{\interpS}[1]{\ensuremath{\interp{#1}_S}}
\newcommand{\interpInd}[1]{\ensuremath{\mathbb{T}\interp{#1}}}
\newcommand{\interpD}[1]{\ensuremath{\interp{#1}_D}}
\newcommand{\interpK}[1]{\ensuremath{\interp{#1}_K}}
\newcommand{\interpTK}[1]{\ensuremath{\interp{#1}_{tokens}}}

\newcommand{\interpP}[1]{\ensuremath{\interp{#1}_P}}
\newcommand{\interpJ}[1]{\ensuremath{\interp{#1}_J}}
\newcommand{\interpA}[1]{\ensuremath{\interp{#1}_A}}

\newcommand{\interpTop}[1]{\ensuremath{\interp{#1}_{\top}}} 
\newcommand{\interpBot}[1]{\ensuremath{\interp{#1}_{\bot}}}
\newcommand{\interpCons}[1]{\ensuremath{\interp{#1}_{cond}}}
\def\aids{\mathit{aids}}
\def\args{\mathit{args}}
\def\lst{\mathit{l}}
\def\bs{\mathit{bs}}
\def\prefix{\mathit{prefix}}
\def\tail{\mathit{tail}}
\newcommand{\bitstring}{\mathit{BS}}
\def\remains{\mathit{remains}}
\def\ori{\mathit{ori}}
\def\argi{\mathit{argi}}
\def\orilst{\mathit{orilst}}
\def\firstn{\mathit{first\_n}}
\def\skipn{\mathit{skip\_n}}
\def\skipt{\mathit{skip\_t}}
\def\clear{\mathit{clear}}

\newcommand{\topcode}{\mathit{Opcode}}
\newcommand{\tdisp}{\mathit{Disp}}
\newcommand{\timms}{\mathit{Imms}}
\newcommand{\tmodrm}{\mathit{ModRM}}
\newcommand{\tsib}{\mathit{SIB}}

\newcommand{\fopcode}{\mathit{opcode}}
\newcommand{\fdisp}{\mathit{disp}}
\newcommand{\fimms}{\mathit{imms}}
\newcommand{\fmod}{\mathit{mod}}
\newcommand{\frm}{\mathit{rm}}
\newcommand{\fscale}{\mathit{scale}}
\newcommand{\findex}{\mathit{index}}
\newcommand{\fbase}{\mathit{base}}
\newcommand{\fregop}{\mathit{reg\_op}}

\newcommand{\caddrmode}{\mathit{Addrmode}}
\newcommand{\caddrr}{\mathit{addr\_r}}
\newcommand{\caddrir}{\mathit{addr\_ir}}
\newcommand{\caddrsib}{\mathit{addr\_sib}}
\newcommand{\caddrdisp}{\mathit{addr\_disp}}

\newcommand{\cinstr}{\mathit{Instruction}}
\newcommand{\caddei}{\mathit{AddEvIz}}
\newcommand{\caddge}{\mathit{AddGvEv}}

\newcommand{\utype}[1]{\langle #1 \rangle}

\newcommand{\validinput}[2]{\mathit{valid\_input}_{#1}(#2)}

%% Tabular
\setlength{\tabcolsep}{0.5em} % for the horizontal padding



% ch4
%% \newcommand{\interpMsk}[1]{\ensuremath{\interp{#1}_{mask}}}
%% \newcommand{\encoder}[1]{\mathbb{E}(#1)}

%% Math Formatting %%%
\RequirePackage{relsize}

\newcommand\br{\par\nobreak\noindent}
\newenvironment{smallgather}
  {\br\bgroup\small\csname gather*\endcsname}
  {\csname endgather*\endcsname\egroup}
\newenvironment{smallalign}
  {\br\bgroup\small\csname align*\endcsname}
  {\csname endalign*\endcsname\egroup}


%% Tikz
\tikzstyle{component}=[draw=black, fill=white, rectangle, rounded corners = 0.08cm, minimum width=0.8cm, minimum height=0.5cm]
\usetikzlibrary{positioning,fit,shapes,calc,decorations.shapes,patterns}

% TikZ configurations
\tikzstyle{segment}=[draw, black, rectangle, inner sep=0pt]

\newcommand{\blk}[3]{\node[draw, rounded corners=.05cm, black, minimum width=#1cm, minimum height=#2cm,inner sep=0.0cm,#3]}
\newcommand{\langblk}[1]{\blk{2}{1}{thick,#1}}
\newcommand{\Cross}{$\mathbin{\tikz [x=1.4ex,y=1.4ex,line width=.2ex, red] \draw (0,0) -- (1,1) (0,1) -- (1,0);}$}
\newcommand{\nblk}[3]{\node[draw, black, minimum width=#1cm, minimum height=#2cm,inner sep=0.0cm,#3]}

\tikzset{decorate sep/.style 2 args={decorate,decoration={shape backgrounds,shape=circle,shape size=#1,shape sep=#2}}}


%%% Comments
\newtoggle{comments}
\toggletrue{comments}

\newcommand{\namecomment}[3]{\iftoggle{comments}{\textbf{\textcolor{#2}{[#3 -- #1]}}}{}}
\newcommand{\yuting}[1]{\namecomment{Yuting}{red}{#1}}

